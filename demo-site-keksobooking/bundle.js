(()=>{"use strict";(()=>{const e=document.querySelector(".map"),n=e.querySelector(".map__pin--main");window.mainElement={map:e,pin:n}})(),(()=>{const e={COORDS_X:570,COORDS_Y:375,GUESTS_COUNT:1,MAX_COUNT:5,MIN_WIDTH_PINS:50,MIN_HEIGHT_PINS:70,MIN_LOCATION_X:0,MAX_LOCATION_X:document.querySelector(".map").offsetWidth,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,NUMBER_GUEST:{1:[1],2:[1,2],3:[1,2,3],100:[0]},TYPES:{palace:{ru:"Дворец",min:"10000"},flat:{ru:"Квартира",min:"1000"},house:{ru:"Дом",min:"5000"},bungalow:{ru:"Бунгало ",min:"0"}}};window.constants=e})(),(()=>{const e={LEFT_MOUSE:0,ENTER:13,ESC:27};window.util={key:e,onEnterEvent:function(n,t){n.keyCode===e.ENTER&&t()},onEscEvent:function(n,t){n.keyCode===e.ESC&&(n.preventDefault(),t())}}})(),window.debounce=function(e){let n=null;return function(...t){n&&window.clearTimeout(n),n=window.setTimeout((function(){e(...t)}),500)}},(()=>{let e=!1;const n=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),r=function(){s()},i=function(){s()},c=function(e){window.util.onEscEvent(e,s)},d=function(){document.addEventListener("keydown",c),document.addEventListener("mousedown",i)},s=function(){const n=e?".error":".success";document.querySelector(n).remove(),document.removeEventListener("keydown",c),document.removeEventListener("mousedown",i)};window.message={onErrorSend:function(o){e=!0;const i=t.cloneNode(!0);i.querySelector(".error__message").textContent=o,i.querySelector(".error__button").addEventListener("click",r),n.appendChild(i),d()},onSuccessSend:function(){e=!1;const t=o.cloneNode(!0);n.appendChild(t),d()}}})(),(()=>{const e=function(e,n,t){let o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(function(){200===o.status?e(o.response):n("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+o.timeout+"мс")})),t?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(t)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())};window.backend={load:e,save:e}})(),(()=>{const e=window.mainElement.map.querySelector(".map__filters-container"),n=e.querySelector("form"),t={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},o=Array.from(n.children),r={"housing-type":function(e,n){return n.value===e.offer.type},"housing-price":function(e,n){return e.offer.price>=t[n.value].start&&e.offer.price<t[n.value].end},"housing-rooms":function(e,n){return n.value===e.offer.rooms.toString()},"housing-guests":function(e,n){return n.value===e.offer.guests.toString()},"housing-features":function(e,n){return Array.from(n.querySelectorAll("input[type=checkbox]:checked")).every((function(n){return e.offer.features.some((function(e){return e===n.value}))}))}},i=function(e){return e.filter((function(e){return o.every((function(n){return"any"===n.value||r[n.id](e,n)}))}))},c=window.debounce((function(){window.card.remove(),window.pin.remove(),window.pin.render(i(window.main.offers()).slice(0,window.constants.MAX_COUNT))}));n.addEventListener("change",c),window.filter={element:{container:e,form:n},filterData:i}})(),(()=>{const e=window.constants.TYPES,n=document.querySelector(".ad-form"),t=n.querySelectorAll("fieldset"),o=n.querySelector("#address"),r=n.querySelector("#type"),i=n.querySelector("#price"),c=n.querySelector("#room_number"),d=n.querySelector("#capacity"),s=n.querySelector("#timein"),u=n.querySelector("#timeout"),a=n.querySelector(".ad-form__reset"),l=window.constants.NUMBER_GUEST,f=window.filter.element.form.querySelectorAll(".map__filter");o.readOnly=!0;const p=function(e){for(let n=0;n<e.length;n++)e[n].disabled=!0},m=function(e){for(let n=0;n<e.length;n++)e[n].disabled=!1},w=function(){i.min=e[r.value].min,i.placeholder=e[r.value].min};r.addEventListener("change",w),c.addEventListener("change",(function(){!function(e){const n=d.querySelectorAll("option");for(let e=0;e<n.length;e++)n[e].disabled=!0;l[e].forEach((function(e){d.querySelector(`[value="${e}"]`).disabled=!1,d.value=e}))}(c.value)})),s.addEventListener("change",(function(){u.value=s.value})),u.addEventListener("change",(function(){s.value=u.value}));const v=function(){window.message.onErrorSend("Ошибка загрузки объявления")},_=function(){window.message.onSuccessSend(),window.main.deactivatePage()};n.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(_,v,new FormData(n))})),a.addEventListener("click",(function(e){e.preventDefault(),window.main.deactivatePage()})),window.form={element:{ad:n,pinAddressInput:o},setAddressCoords:function(e,n){o.value=e+","+n},setDisabled:function(){p(t),p(f)},setActive:function(){m(t),m(f)},onTypeSelectChange:w}})(),(()=>{const e=window.constants.MIN_WIDTH_PINS,n=window.constants.MIN_HEIGHT_PINS,t=window.mainElement.map,o=t.querySelector(".map__pins"),r=window.filter.element.container,i=document.querySelector("#pin").content,c=function(c){const s=i.querySelector(".map__pin").cloneNode(!0);s.querySelector("img").src=c.author.avatar,s.querySelector("img").alt=c.offer.description;let u=c.location.x-e/2+"px",a=c.location.y-n+"px";return s.style.left=u,s.style.top=a,o.appendChild(s),s.addEventListener("click",(function(){d(),s.classList.add("map__pin--active"),window.card.remove(),t.insertBefore(window.card.create(c),r)})),s},d=function(){const e=t.querySelector(".map__pin--active");null!==e&&e.classList.remove("map__pin--active")};window.pin={create:c,render:function(e){const n=document.createDocumentFragment();e.forEach((function(e){n.appendChild(c(e))})),o.appendChild(n)},remove:function(){const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&e.forEach((function(e){e.remove()}))},removeActive:d}})(),(()=>{const e=window.util.onEscEvent,n=window.constants.TYPES,t=window.mainElement.map,o=document.querySelector("#card").content,r=function(n){const o=t.querySelector(".popup");e(n,(function(){null!==o&&(i(),document.removeEventListener("keydown",r),window.pin.removeActive())}))},i=function(){let e=t.querySelector(".popup");null!==e&&e.remove()};window.card={create:function(e){const t=o.querySelector(".map__card").cloneNode(!0);t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__avatar").alt=e.offer.description,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=n[e.offer.type].ru,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${e.offer.rooms===window.constants.GUESTS_COUNT?"комната":"комнаты"} для ${e.offer.guests} ${e.offer.guests===window.constants.GUESTS_COUNT?"гостя":"гостей"}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;const c=t.querySelector(".popup__features"),d=t.querySelectorAll(".popup__feature");for(let n of d)e.offer.features.indexOf(n.classList[1].replace("popup__feature--",""))<0&&n.remove(),0===e.offer.features.length&&c.remove();t.querySelector(".popup__description").textContent=e.offer.description;const s=t.querySelector(".popup__photos"),u=s.querySelector(".popup__photo");if(e.offer.photos.length>0){u.remove();for(let n of e.offer.photos){const e=document.querySelector("#card").content.querySelector(".popup__photo").cloneNode(!0);e.src=n,s.appendChild(e)}}else s.remove();const a=t.querySelector(".popup__close");return document.addEventListener("keydown",r),a.addEventListener("click",(function(){i(),window.pin.removeActive(),document.removeEventListener("keydown",r)})),t},remove:i}})(),(()=>{const e=["gif","jpg","jpeg","png"],n=70,t=70,o="Фотография жилья",r=window.form.element.ad,i=r.querySelector(".ad-form-header__upload input[type=file]"),c=r.querySelector(".ad-form-header__upload img"),d=c.src,s=r.querySelector(".ad-form__photo-container"),u=r.querySelector(".ad-form__upload input[type=file]"),a=r.querySelector(".ad-form__photo");let l=[];const f=function(n,t){const o=n.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t(e.result)})),e.readAsDataURL(o)}};i.addEventListener("change",(function(){f(i,(function(e){c.src=e}))})),u.addEventListener("change",(function(){f(u,p)}));const p=function(e){const r=document.createElement("div");r.classList.add("ad-form__photo");const i=document.createElement("img");i.src=e,i.width=n,i.height=t,i.alt=o,r.appendChild(i),l.push(r),s.insertBefore(r,a)};window.preview={reset:function(){l&&l.forEach((function(e){e.remove()})),l=[],c.src=d}}})(),(()=>{const e=window.mainElement.pin,n=e.clientWidth,t=e.clientHeight,o=window.constants.MIN_LOCATION_X,r=window.constants.MIN_LOCATION_Y,i=window.constants.MAX_LOCATION_Y,c=window.constants.MAX_LOCATION_X;e.addEventListener("mousedown",(function(d){if(d.button===window.util.key.LEFT_MOUSE){d.preventDefault();let s={x:d.clientX,y:d.clientY};const u=function(d){d.preventDefault();let u={x:s.x-d.clientX,y:s.y-d.clientY};s={x:d.clientX,y:d.clientY},function(d){let s=e.offsetTop-d.y,u=e.offsetLeft-d.x;u>c-n/2?u=c-n/2:u<o-n/2&&(u=o-n/2),s>i-t?s=i-t:s<r-t&&(s=r-t),e.style.top=s+"px",e.style.left=u+"px",window.form.element.pinAddressInput.value=Math.round(parseInt(e.style.left,10)+n/2)+", "+Math.round(parseInt(e.style.top,10)+t/2)}(u)},a=function(e){e.preventDefault(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",u),document.addEventListener("mouseup",a)}}))})(),(()=>{const e=window.constants.MAX_COUNT,n=window.constants.COORDS_X,t=window.constants.COORDS_Y,o=window.mainElement.map,r=window.mainElement.pin,i=window.filter.element.form,c=window.form.element.ad;let d=[];window.form.setAddressCoords(n,t),window.form.setDisabled();const s=function(n){d=n.slice().filter((function(e){return 0!==Object.keys(e.offer).length})),window.pin.render(d.slice(0,e)),window.form.setActive(),o.classList.remove("map--faded"),c.classList.remove("ad-form--disabled"),r.removeEventListener("mousedown",l),r.removeEventListener("keydown",f)},u=function(e){window.message.onErrorSend(e)},a=function(){window.backend.load(s,u)},l=function(e){e.button===window.util.key.LEFT_MOUSE&&a()},f=function(e){window.util.onEnterEvent(e,(function(){a()}))};r.addEventListener("mousedown",l),r.addEventListener("keydown",f),window.main={offers:()=>d,deactivatePage:function(){o.classList.add("map--faded"),i.reset(),c.reset(),c.classList.add("ad-form--disabled"),window.form.onTypeSelectChange(),window.form.setDisabled(),window.form.setAddressCoords(n,t),r.style.left=n+"px",r.style.top=t+"px",window.card.remove(),window.pin.remove(),window.preview.reset(),r.addEventListener("mousedown",l),r.addEventListener("keydown",f)}}})()})();